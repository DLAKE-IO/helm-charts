name: Release and Publish Charts

on:
  push:
    branches:
      - main
    paths:
      - "charts/**"
  workflow_dispatch:

env:
  HELM_VERSION: "v3.15.2"
  HELM_DOCS_VERSION: "1.14.2"

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "helm-bot"
          git config user.email "helm-bot@users.noreply.github.com"

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: ${{ env.HELM_VERSION }}

      - name: Add dependency chart repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo update

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run chart-releaser (GitHub Pages)
        uses: helm/chart-releaser-action@v1.7.0
        with:
          charts_dir: charts
          config: "./.github/configs/cr.yaml"
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Install cosign
        uses: sigstore/cosign-installer@v4.0.0

      - name: Push charts to GHCR as OCI artifacts
        id: push-oci
        run: |
          shopt -s nullglob
          released_charts=""
          rm -f .oci-digests

          for pkg in .cr-release-packages/*.tgz; do
            chart_name=$(basename "${pkg}" .tgz)
            echo "üì¶ Publishing ${chart_name} to GHCR..."

            output=$(helm push "${pkg}" "oci://ghcr.io/${{ github.repository_owner }}/charts" 2>&1)
            echo "$output"

            # helm push outputs:
            #   Pushed: oci://ghcr.io/owner/charts/name:version
            #   Digest: sha256:...
            pushed_ref=$(echo "$output" | grep "^Pushed:" | sed 's|^Pushed: oci://||')
            digest=$(echo "$output" | grep "^Digest:" | awk '{print $2}')

            if [ -z "${digest}" ]; then
              echo "‚ùå Failed to extract digest for ${chart_name}"
              exit 1
            fi

            # Build cosign reference: repo@sha256:... (no tag, exact digest)
            chart_repo="${pushed_ref%:*}"
            cosign_ref="${chart_repo}@${digest}"
            echo "${cosign_ref}" >> .oci-digests

            echo "‚úÖ Pushed: ${pushed_ref} (${digest})"
            released_charts="${released_charts}${chart_name}, "
          done

          echo "released_charts=${released_charts%, }" >> $GITHUB_OUTPUT

      - name: Sign charts with cosign
        if: steps.push-oci.outputs.released_charts != ''
        run: |
          if [ ! -f .oci-digests ]; then
            echo "No digests file found ‚Äî nothing to sign"
            exit 0
          fi
          while IFS= read -r ref; do
            [ -n "${ref}" ] || continue
            echo "üîê Signing ${ref}..."
            cosign sign --yes "${ref}"
            echo "‚úÖ Signed: ${ref}"
          done < .oci-digests

      - name: Install helm-docs
        if: steps.push-oci.outputs.released_charts != ''
        run: |
          cd /tmp
          wget -q https://github.com/norwoodj/helm-docs/releases/download/v${HELM_DOCS_VERSION}/helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          tar -xzf helm-docs_${HELM_DOCS_VERSION}_Linux_x86_64.tar.gz
          sudo mv helm-docs /usr/local/bin/

      - name: Update READMEs and root chart table
        if: steps.push-oci.outputs.released_charts != ''
        run: |
          helm-docs
          python3 scripts/update-readme.py
          git add README.md charts/*/README.md
          git diff --staged --quiet || git commit -m "docs: regenerate READMEs after release"
          git push

      - name: Generate release summary
        if: steps.push-oci.outputs.released_charts != ''
        run: |
          echo "## üöÄ Charts Released Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Released Charts:** ${{ steps.push-oci.outputs.released_charts }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã Distribution Channels" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **GitHub Pages (Helm Repository)**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   helm repo add ${{ github.repository_owner }} https://${{ github.repository_owner }}.github.io/helm-charts/" >> $GITHUB_STEP_SUMMARY
          echo "   helm repo update" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **GitHub Container Registry (OCI)**" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "   helm pull oci://ghcr.io/${{ github.repository_owner }}/charts/<chart-name> --version <version>" >> $GITHUB_STEP_SUMMARY
          echo "   \`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Security" >> $GITHUB_STEP_SUMMARY
          echo "- All charts are signed with cosign" >> $GITHUB_STEP_SUMMARY
          echo "- Release notes automatically generated" >> $GITHUB_STEP_SUMMARY

      - name: No releases needed
        if: steps.push-oci.outputs.released_charts == ''
        run: |
          echo "## ‚ÑπÔ∏è No New Releases" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No chart version bumps detected. Charts are only released when the \`version\` field in Chart.yaml is incremented." >> $GITHUB_STEP_SUMMARY
